name: コンパイラテスト
on: [push]

jobs:
  compiler_test:
    runs-on: ubuntu-latest

    steps:
      # リポジトリをチェックアウト
      - name: Checkout
        uses: actions/checkout@v4

      # GraalVM 21をインストール
      - uses: actions/setup-java@v4
        with:
          distribution: 'graalvm'
          java-version: '21'

      # Minecraft Serverをセットアップ
      - name: Set up Minecraft Server
        run: |
          wget https://api.papermc.io/v2/projects/paper/versions/1.21.3/builds/82/downloads/paper-1.21.3-82.jar -O ~/server.jar
          (cd ~ && java -jar server.jar nogui)
          sed -i 's/false/true/g' ~/eula.txt

      #プラグイン環境のセットアップ
      - name: Set up plugin environments
        run: |
          mkdir -p ~/plugins/Skript/scripts/
          mv ./.github/workflows/plugins/Skript-2.10.1.jar ~/plugins/
          mv ./.github/workflows/plugins/SkBee-3.8.2.jar ~/plugins/
          cp -r * ~/plugins/Skript/scripts/
      
      # Minecraft Serverのランタイムテスト
      - name: Run Minecraft Server for Runtime test
        run: (cd ~ && java -jar server.jar nogui)
      
      # ランタイムテストの結果処理
      - name: Check result of Compile
        run: |
            if grep -q '\[Skript\] Line' ~/logs/latest.log; then
              exit 1
            fi

      - name: Check result of Runtime
        run: |
            if grep -q 'THEMININGS2_TEST_FAILED' ~/logs/latest.log; then
              exit 1
            fi
